<html>
<head>
<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>

<script src="js/jquery.xmpp.js"></script>
<script type="text/javascript">
// use this document for creating XML

var _timer_start = '';

function htmlentities(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function microtime (get_as_float) {
    // http://kevin.vanzonneveld.net
    // +   original by: Paulo Freitas
    // *     example 1: timeStamp = microtime(true);
    // *     results 1: timeStamp > 1000000000 && timeStamp < 2000000000
    var now = new Date().getTime() / 1000;
    var s = parseInt(now, 10);

    return (get_as_float) ? now : (Math.round((now - s) * 1000) / 1000) + ' ' + s;
}

var doc = document.implementation.createDocument(null, null, null);

var sequenceNumber = 1;

// function that creates the XML structure
// Very sexy solution from http://stackoverflow.com/questions/3191179/generate-xml-document-in-memory-with-javascript
function xmlIt() {
    var node = doc.createElement(arguments[0]), text, child;

    for(var i = 1; i < arguments.length; i++) {
        child = arguments[i];
        if(typeof child == 'string') {
            child = doc.createTextNode(child);
        }
        node.appendChild(child);
    }

    return node;
};

//13410994709790

   $.xmpp.connect({resource:"MyChat", jid:"boshtest@9thsense.com", password:"9thsense", url:"http://9thsense.com:5280/http-bind", 
   onDisconnect:function(){
      alert("Disconnected");
   },onConnect: function(){
        $.xmpp.setPresence(null);
        console.log("Connected");
   },
   onIq: function(iq){
       console.log(iq);
   },onMessage: function(message){
        console.log("New message from " + message.from + ": "+message.body);
        jQuery('#response').html(message.body);
   },onPresence: function(presence){
        console.log("New presence from " + presence.from + " is "+presence.show);
   },onError: function(error){
        console.log("Error: "+error);
   }
   });
	$.xmpp.setPresence(null);
$(document).ready(function() {
	$('.button').click(function () {
		newDoc = 
					xmlIt ('m',
						xmlIt('t', String(microtime(true)).replace('.', '') + '0|' + String(sequenceNumber++)),
						xmlIt('d', jQuery('#robotTo').val()),
						xmlIt('dn', jQuery('#robotTo').val()),
						xmlIt('r', jQuery('#robotTo').val()),
						xmlIt('c', jQuery('#robotCommand').val()),
						xmlIt('a', jQuery('#robotCommandArguments').val()),
						xmlIt('co', jQuery('#robotComment').val())
					);
		var tmp = document.createElement("div");
		tmp.appendChild(newDoc);
		console.log(tmp.innerHTML);

		$.xmpp.sendMessage({to:"helo.five@9thsense.com", resource:"a", body: htmlentities(tmp.innerHTML) },
   function(){ console.log("Sent" + tmp.innerHTML); });
	});

});
</script>
</head>
<body>
Send to: <input type="text" id="robotTo" size="30" value="helo.five@9thsense.com" /><br />
Command: <input type="text" id="robotCommand" size="2" value="x" /><br />
Argument: <input type="text" id="robotCommandArguments" size="4" value="220" /><br />
Comment: <input type="text" id="robotComment" size="30" value="" /><br />

<button class="button">Send it</button>
<p />
<strong>Response</strong><br />
<span style="left-margin: 10px;" id="response"></span><p />
</body>
</html>

